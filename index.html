<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TRIP PROGRESS</title>
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0b0e14">
    
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/1572/1572544.png">
    <link rel="manifest" href="manifest.json">

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        :root {
            --bg: #0b0e14;
            --card-bg: #161b22;
            --text: #ffffff;
            --sub: #8b949e;
            --accent: #00f2ff;
            --glow: rgba(0, 242, 255, 0.5);
        }

        .light {
            --bg: #f0f2f5;
            --card-bg: #ffffff;
            --text: #1c1e21;
            --sub: #606770;
            --accent: #0077ff;
            --glow: rgba(0, 119, 255, 0.3);
        }

        body {
            margin: 0;
            background: var(--bg);
            color: var(--text);
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            transition: all 0.4s ease;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            overflow: hidden;
        }

        .card {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 28px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            text-align: center;
            width: 100%;
            max-width: 380px;
            margin: 20px;
            box-sizing: border-box;
        }

        .status-label {
            font-size: 0.85em;
            color: var(--sub);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .progress-box {
            position: relative;
            width: 220px;
            height: 220px;
            margin: 0 auto 15px;
        }

        svg {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }

        circle {
            fill: none;
            stroke-width: 12;
            stroke-linecap: round;
        }

        .bg-circle { stroke: rgba(128, 128, 128, 0.1); }

        .progress-circle {
            stroke: var(--accent);
            stroke-dasharray: 660;
            stroke-dashoffset: 660;
            transition: stroke-dashoffset 1s linear;
            filter: drop-shadow(0 0 10px var(--glow));
        }

        .info {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
        }

        .percent {
            font-size: 2.4em;
            font-weight: 800;
        }

        .time {
            margin-top: 10px;
            font-size: 1.15em;
            color: var(--text);
            font-weight: 600;
            min-height: 1.5em;
        }

        .controls {
            margin-top: 25px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            padding-top: 20px;
            border-top: 1px solid rgba(128,128,128,0.1);
        }

        .input-group {
            grid-column: span 2;
            text-align: left;
        }

        label { font-size: 0.75em; color: var(--sub); font-weight: bold; }

        input {
            width: 100%;
            background: rgba(128,128,128,0.08);
            border: 1px solid rgba(128,128,128,0.2);
            padding: 10px;
            border-radius: 10px;
            color: var(--text);
            margin-top: 5px;
            box-sizing: border-box;
            outline: none;
            font-size: 16px;
        }

        button {
            background: none;
            color: var(--accent);
            border: 2px solid var(--accent);
            padding: 12px;
            border-radius: 14px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
            touch-action: manipulation;
        }

        button:active { transform: scale(0.95); }
        button:hover {
            background: var(--accent);
            color: white;
            box-shadow: 0 0 20px var(--glow);
        }

        button.secondary { border-color: var(--sub); color: var(--sub); }

        @media (max-width: 400px) {
            .card { padding: 20px; }
            .progress-box { width: 180px; height: 180px; }
            .percent { font-size: 1.8em; }
        }
    </style>
</head>
<body>

<div class="card">
    <div class="status-label" id="status">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    
    <div class="progress-box">
        <svg viewBox="0 0 240 240">
            <circle class="bg-circle" cx="120" cy="120" r="105"/>
            <circle class="progress-circle" id="circle" cx="120" cy="120" r="105"/>
        </svg>
        <div class="info">
            <div class="percent" id="percent">0.00%</div>
        </div>
    </div>
    
    <div class="time" id="time">00:00:00</div>

    <div class="controls">
        <div class="input-group">
            <label>–ù–∞—á–∞–ª–æ –ø–æ–µ–∑–¥–∫–∏</label>
            <input type="datetime-local" id="startInput">
        </div>
        <div class="input-group">
            <label>–ü—Ä–∏–±—ã—Ç–∏–µ</label>
            <input type="datetime-local" id="endInput">
        </div>
        <div class="input-group">
            <label>–¶–≤–µ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞</label>
            <input type="color" id="colorPicker" value="#00f2ff">
        </div>
        <button onclick="handleTheme()" class="secondary">–¢–µ–º–∞</button>
        <button onclick="handleApply()">–û–±–Ω–æ–≤–∏—Ç—å</button>
    </div>
</div>

<audio id="gongSound" src="https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3"></audio>

<script>
    let START_DATE = new Date("2025-12-23T15:00:00+03:00");
    let END_DATE   = new Date("2026-01-11T19:00:00+03:00");
    let hasFinished = false;

    const circle = document.getElementById("circle");
    const percentEl = document.getElementById("percent");
    const timeEl = document.getElementById("time");
    const statusEl = document.getElementById("status");
    const gong = document.getElementById("gongSound");
    const colorPicker = document.getElementById("colorPicker");

    const radius = 105;
    const circumference = 2 * Math.PI * radius;

    function vibrate(ms = 30) {
        if (navigator.vibrate) navigator.vibrate(ms);
    }

    function init() {
        const savedStart = localStorage.getItem("start");
        const savedEnd = localStorage.getItem("end");
        const savedColor = localStorage.getItem("accentColor");

        if (savedStart) START_DATE = new Date(savedStart);
        if (savedEnd) END_DATE = new Date(savedEnd);
        
        if (savedColor) {
            updateAccentColor(savedColor);
            colorPicker.value = savedColor;
        }

        const tzOffset = (new Date()).getTimezoneOffset() * 60000;
        document.getElementById("startInput").value = new Date(START_DATE - tzOffset).toISOString().slice(0, 16);
        document.getElementById("endInput").value = new Date(END_DATE - tzOffset).toISOString().slice(0, 16);
        
        if (localStorage.getItem("theme") === "light") document.body.classList.add("light");
        
        update();
        setInterval(update, 1000);
    }

    function updateAccentColor(color) {
        document.documentElement.style.setProperty('--accent', color);
        const r = parseInt(color.slice(1,3), 16), 
              g = parseInt(color.slice(3,5), 16), 
              b = parseInt(color.slice(5,7), 16);
        document.documentElement.style.setProperty('--glow', `rgba(${r},${g},${b}, 0.5)`);
    }

    function handleApply() {
        vibrate(50);
        applySettings();
    }

    function applySettings() {
        START_DATE = new Date(document.getElementById("startInput").value);
        END_DATE = new Date(document.getElementById("endInput").value);
        const newColor = colorPicker.value;
        
        localStorage.setItem("start", START_DATE);
        localStorage.setItem("end", END_DATE);
        localStorage.setItem("accentColor", newColor);
        
        updateAccentColor(newColor);
        hasFinished = false;
        update();
    }

    function launchConfetti() {
        const end = Date.now() + 4000;
        const colors = [colorPicker.value, '#ffffff'];
        (function frame() {
            confetti({ particleCount: 3, angle: 60, spread: 55, origin: { x: 0 }, colors: colors });
            confetti({ particleCount: 3, angle: 120, spread: 55, origin: { x: 1 }, colors: colors });
            if (Date.now() < end) requestAnimationFrame(frame);
        }());
    }

    function update() {
        const now = new Date();
        if (now < START_DATE) {
            render(0, START_DATE - now, "–î–æ –Ω–∞—á–∞–ª–∞");
            return;
        }
        const total = END_DATE - START_DATE;
        const remaining = END_DATE - now;
        if (remaining > 0) {
            const progress = Math.min((now - START_DATE) / total, 1);
            render(progress, remaining, "–í –ø—É—Ç–∏");
        } else {
            if (!hasFinished) {
                gong.play().catch(() => {});
                launchConfetti();
                vibrate([100, 50, 100]);
                hasFinished = true;
            }
            render(1, 0, "–ú—ã –Ω–∞ –º–µ—Å—Ç–µ! üéâ");
        }
    }

    function render(prog, ms, label) {
        statusEl.textContent = label;
        percentEl.textContent = (prog * 100).toFixed(2) + "%";
        circle.style.strokeDashoffset = circumference * (1 - prog);
        
        if (ms > 0) {
            const d = Math.floor(ms / 86400000);
            const h = Math.floor((ms % 86400000) / 3600000);
            const m = Math.floor((ms % 3600000) / 60000);
            const s = Math.floor((ms % 60000) / 1000);
            timeEl.textContent = `${d > 0 ? d + '–¥ ' : ''}${h}—á ${m}–º ${s}—Å`;
        } else {
            timeEl.textContent = "–¶–µ–ª—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞!";
        }
    }

    function handleTheme() {
        vibrate(30);
        toggleTheme();
    }

    function toggleTheme() {
        document.body.classList.toggle("light");
        localStorage.setItem("theme", document.body.classList.contains("light") ? "light" : "dark");
    }

    // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è Service Worker
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js').catch(() => {});
    }

    init();
</script>
</body>
</html>
